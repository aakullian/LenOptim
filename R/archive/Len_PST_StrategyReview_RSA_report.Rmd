---
title: "Lenacapavir Scenario Comparison"
author: "Adam Akullian"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 2
    number_sections: true
    fig_caption: true
    fig_width: 8
    fig_height: 5
  word_document:
    toc: true
    toc_depth: '2'
  pdf_document:
    toc: true
    toc_depth: '2'
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)

library(dplyr)
library(tidyr)
library(ggplot2)
library(knitr)
library(purrr)
library(here)
library(kableExtra)
library(stringr)
library(purrr)
library(here)
library(scales)

#sets the directory to where this script is stored#
setwd(dirname(rstudioapi::getSourceEditorContext()$path))

source("Allocate_PrEP_RSA_data_cleaning.R", echo=F)

# Optionally confirm the root:
here::here()  # prints the project root path

# Set working directory to a folder relative to the root
setwd(here("R/RSA_OUTPUT/HIV_PST_Strategy_Review_files"))  # change folder name as needed

# List all RData files matching a naming pattern
files <- list.files(pattern = "^Len_optim_RSA_output_.*\\.RData$")

# Optionally extract scenario names from filenames
scenario_labels <- gsub("\\.RData", "", basename(files))

# Load each RData into a separate environment
envs <- lapply(files, function(f) {
  e <- new.env()
  load(f, envir = e)
  e
})

scenario_results <- map2(envs, scenario_labels, ~{
  .x$outputs$result_df %>%
    mutate(scenario = .y)
})

scenario_tables <- map2(envs, scenario_labels, ~{
  .x$outputs$summary_table %>%
    mutate(scenario = .y)
})

scenario_maps <- map2(envs, scenario_labels, ~{
  .x$outputs$formatted_map 
})

scenario_district_allocation <- map2(envs, scenario_labels, ~{
  .x$outputs$by_prov_dist_age_sex %>%
    mutate(scenario = .y)
})

library(dplyr)
library(stringr)
library(tidyr)

combined_scenario_results <- bind_rows(scenario_results) %>%
  group_by(scenario) %>%
  mutate(
    cum_inf_averted = cumsum(infections_averted),
    inc_reduction = cum_inf_averted / sum(district_new_infections$new_infections),
    cum_coverage = cum_allocated_units / sum(district_new_infections$pop_at_risk),

    # Step 1: Detect if original scenario contains "2districts" (before the quantile)
    has_2districts = str_detect(scenario, regex("2districts", ignore_case = TRUE)),

    # Step 2: Extract only the part after __MF1534quantile_
    scenario_core_raw = str_extract(scenario, "(?<=__MF1534quantile_).*"),

    # Step 3: Clean scenario name
    scenario_core_cleaned = scenario_core_raw %>%
      str_replace("n_", "n") %>%
      str_replace("coverage_mult_ ?", "cm"),

    # Step 4: Reattach _2districts at the end if needed
    scenario_clean = if_else(
      has_2districts,
      paste0(scenario_core_cleaned, "_2districts"),
      scenario_core_cleaned
    ),

    # Step 5: Create cost variables
    cost1 = 100 * cum_allocated_units,
    cost2 = 40 * cum_allocated_units
  ) %>%
  pivot_longer(
    cols = starts_with("cost"),
    names_to = "scenario_base",
    values_to = "cost_value"
  ) %>%
  mutate(
    scenario_cost = paste0(scenario_clean, "_", scenario_base)
  )

combined_summary <- bind_rows(scenario_tables)

combined_summary_table <- combined_summary %>%
  select(-c(budget, cost_per_unit, total_cost))  %>%
  select(scenario, allocation_by_age_sex, everything())  %>%
  rename(
    #`Scenario` = scenario,
    #`Budget (USD)` = budget,
    #`Cost per Unit` = cost_per_unit,
    #`Coverage Multiplier` = coverage_mult,
    `Total Units Allocated` = total_allocated_units,
    `Expected Infections (No PrEP)` = expected_infections_no_prep,
    `Infections Averted` = infections_averted,
    `% Incidence Reduction` = percent_reduction_in_incidence,
    `PrEP Coverage (%)` = prep_coverage,
    #`Total DALYs Averted` = total_dalys_averted,
    #`Total Cost (USD)` = total_cost,
    #`Cost per Infection Averted` = cost_per_infection_averted,
    `Cost per DALY Averted` = cost_per_daly_averted,
    `Number Needed to Treat (NNT)` = number_needed_to_treat,
    `Districts Allocated` = facilities_with_allocation,
    `Avg Incidence (Allocated)` = avg_incidence_allocated,
    `Avg Incidence (Population)` = avg_incidence_population,
    #`Targeting Ratio` = incidence_targeting_ratio,
    #`Allocation by Age/Sex` = allocation_by_age_sex
  )  %>%
  mutate(
    # Strategy description
    scenario_description = case_when(
      str_detect(scenario, "NDOH") ~ "NDoH Prioritization Strategy",
      str_detect(scenario, "DISTRICT") ~ "District Prioritization Strategy",
      TRUE ~ "Uncategorized Strategy"
    )
  ) %>%
  relocate(scenario_description, .after = scenario) %>%
  mutate(
    risk_quantiles = as.numeric(str_extract(scenario, "n_\\d+$") %>% str_remove("n_")),
    strata = str_extract(scenario, "(?<=quantiles__)(.*?)(?=quantile)")
  ) %>%
  relocate(risk_quantiles, .after = scenario) %>%
  relocate(strata, .after = risk_quantiles) %>%
  arrange(risk_quantiles)

combined_scenario_results_random_alloc <- combined_scenario_results %>%
  filter(scenario_cost == "n1cm1_cost1") %>%
  slice_sample(prop = 1) %>%
  mutate(cum_inf_averted = cumsum(infections_averted),
         cum_allocated_units = cumsum(allocated_units),
         cost_value = cum_allocated_units * 100,
         inc_reduction = cum_inf_averted / sum(district_new_infections$new_infections),
         cum_coverage = cum_allocated_units / sum(district_new_infections$pop_at_risk),
         scenario_cost = "random allocation")

```

```{r mapping_2, echo=FALSE, message=FALSE, warning=FALSE,fig.width=20, fig.height=12}


scenarios_to_run = c("n1cm1_cost1", "n2cm1_cost1", "n1cm1_cost2","n1cm1_cost2","n2cm1_cost2","n4cm1_cost2","n20cm1_cost2")

# Plot
plot_data <- combined_scenario_results %>%
  filter(scenario_cost %in% scenarios_to_run) %>%
  bind_rows(combined_scenario_results_random_alloc) %>%
  mutate(
    scenario_label = case_when(
      scenario_cost == "n1cm1_cost1" ~ "District allocation ($100)",
      scenario_cost == "n1cm1_cost2" ~ "District allocation ($40)",
      scenario_cost == "n2cm1_cost2" ~ "District + risk-group targeting (n=2) ($40)",
      scenario_cost == "n2cm1_cost1" ~ "District + risk-group targeting (n=2) ($100)",
      scenario_cost == "n4cm1_cost2" ~ "District + risk-group targeting (n=4) ($40)",
      scenario_cost == "n20cm1_cost2" ~ "District + risk-group targeting (n=20) ($40)",
      scenario_cost == "random allocation" ~ "Random allocation ($100)",
      TRUE ~ scenario_cost
    ),
    scenario_label = factor(
      scenario_label,
      levels = c(
        "District allocation ($100)",
        "District allocation ($40)",
        "District + risk-group targeting (n=2) ($40)",
        "District + risk-group targeting (n=2) ($100)",
        "District + risk-group targeting (n=4) ($40)",
        "District + risk-group targeting (n=20) ($40)",
        "Random allocation ($100)"
      )
    )
  )


scenario_plot <- ggplot(plot_data) +

  # Solid lines for scenarios
  geom_line(
    data = ~ filter(., scenario_label != "Random allocation ($100)"),
    aes(x = cost_value, y = inc_reduction*100, color = scenario_label, linetype = scenario_label),
    size = 1.2
  ) +

  # Smoothed dashed line for random allocation
geom_smooth(
  data = ~ filter(., scenario_label == "Random allocation ($100)"),
  aes(x = cost_value, y = inc_reduction*100, color = scenario_label, linetype = scenario_label),
  method = "lm",
  se = FALSE,
  size = 1.2
) +

  scale_color_manual(
    values = c(
      "District allocation ($100)" = "#1b9e77",
      "District allocation ($40)" = "#d95f02",
      "District + risk-group targeting (n=2) ($40)" = "#e7298a",
      "District + risk-group targeting (n=2) ($100)" = "blue",
      "District + risk-group targeting (n=4) ($40)" = "#66a61e",
      "District + risk-group targeting (n=20) ($40)" = "#7570b3",
      "Random allocation ($100)" = "black"
    )
  ) +
  scale_linetype_manual(
    values = c(
      "District allocation ($100)" = "solid",
      "District allocation ($40)" = "solid",
      "District + risk-group targeting (n=2) ($40)" = "solid",
       "District + risk-group targeting (n=2) ($100)" = "solid",
      "District + risk-group targeting (n=4) ($40)" = "solid",
      "District + risk-group targeting (n=20) ($40)" = "solid",
      "Random allocation ($100)" = "dashed"
    )
  ) +

  labs(
    title = "Cumulative Infections Averted by Coverage",
    x = "Cost ($)",
    y = "Cumulative Infections Averted (%)",
    color = "Strategy",
    linetype = "Strategy"
  ) +
  scale_x_continuous(
  labels = scales::label_number(scale = 1e-6, suffix = "M", accuracy = 1)
) +
  theme_minimal(base_size = 24) +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "right"
  )


results_df <- plot_data %>%
  ungroup() %>%
  #filter(scenario_cost %in% scenarios_to_run) %>% 
  mutate(sex_age_group = "MF 15-34",
         cost_per_py = cost_value / cum_allocated_units)  %>% 
  filter(allocated_units > 0)  %>%
  dplyr::select(scenario_cost, cost_per_py, sex_age_group, district, age_group_label, sex, quantile_target_factor,inc_in_sample, allocated_units, cost_value, cum_allocated_units, cum_coverage, cum_inf_averted, inc_reduction) %>%
  arrange(scenario_cost)

write.csv(results_df, "model_scenarios_v2.csv", row.names = FALSE)
ggsave(plot = scenario_plot, "model_scenarios_plot_v2.png", dpi = 300, width = 7, height = 5)

scenario_plot

```

```{r 2district plots, echo=FALSE, message=FALSE, warning=FALSE,fig.width=20, fig.height=12, out.width="100%"}

library(dplyr)
library(stringr)
library(ggplot2)
library(scales)

# Step 1: Select cost1 + 2districts scenarios and clean names
scenarios_to_run <- combined_scenario_results %>%
  #filter(str_detect(scenario_cost, "_2districts"), str_detect(scenario_cost, "cost1")) %>%
  filter(str_detect(scenario_cost, "_2districts"), str_detect(scenario_cost, "cost1"), str_detect(scenario_cost, "cm1")) %>%
  distinct(scenario_cost) %>%
  pull(scenario_cost) 
  #str_remove("2districts_")  # Remove 2districts_ from the name

# Step 2: Create plot data and human-readable labels
plot_data <- combined_scenario_results %>%
  filter(scenario_cost %in% scenarios_to_run) %>%
  mutate(
    n = as.numeric(str_extract(scenario_cost, "(?<=n)\\d+")),
    coverage = as.numeric(str_extract(scenario_cost, "(?<=cm)[0-9.]+")),
    scenario_label = paste0(n, " risk group", ifelse(n > 1, "s", ""),
                            " at ", coverage, " coverage (2 districts)")
  ) %>%
  group_by(scenario_cost) %>%
  mutate(
    inc_reduction_2district = cum_inf_averted / sum(district_new_infections$new_infections[district_new_infections$area_id %in% c("ZAF_2_ETH","ZAF_2_DC27")]),
    cum_coverage_2district = cum_allocated_units / sum(district_new_infections$pop_at_risk[district_new_infections$area_id %in% c("ZAF_2_ETH","ZAF_2_DC27")])
  )

# Step 3: Order factor levels by n and coverage
plot_data$scenario_label <- factor(
  plot_data$scenario_label,
  levels = expand.grid(
    n = c(1, 2, 4, 10, 20),
    coverage = c(0.25, 0.5, 1)
  ) %>%
    arrange(n, coverage) %>%
    mutate(label = paste0(
      n, " risk group", ifelse(n > 1, "s", ""),
      " at ", coverage, " coverage (2 districts)")
    ) %>%
    pull(label)
)

# Step 4: Plot
scenario_plot <- ggplot(plot_data) +
  geom_line(
    aes(x = cum_coverage_2district*100, y = inc_reduction_2district * 100,
        color = scenario_label, linetype = scenario_label),
    size = 1.2
  ) +
  scale_color_manual(
  values = setNames(
    viridis::viridis(n = length(levels(plot_data$scenario_label)), option = "D"),
    levels(plot_data$scenario_label)
  )
) +
  scale_linetype_manual(
    values = setNames(
      rep("solid", length(levels(plot_data$scenario_label))),
      levels(plot_data$scenario_label)
    )
  ) +
  # scale_x_continuous(
  #   labels = label_number(scale = 1e-6, suffix = "M", accuracy = 1)
  # ) +
  labs(
    title = "Cumulative Infections Averted by Coverage (uMkhanyakude & eThekwini)",
    x = "Coverage (%)",
    y = "Cumulative Infections Averted (%)",
    color = "Strategy",
    linetype = "Strategy"
  ) +
  theme_minimal(base_size = 24) +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(color = "black"),
    plot.title = element_text(face = "bold", hjust = 0.5),
    legend.position = "right"
  )

# Show plot
print(scenario_plot)

results_df <- plot_data %>%
  ungroup() %>%
  filter(scenario_cost %in% scenarios_to_run) %>% 
  mutate(sex_age_group = "MF 15-34",
         cost_per_py = cost_value / cum_allocated_units)  %>% 
  filter(allocated_units > 0)  %>%
  dplyr::select(scenario_cost, cost_per_py, sex_age_group, district, age_group_label, sex, quantile_target_factor,inc_in_sample, allocated_units, cost_value, cum_allocated_units, cum_coverage, cum_inf_averted, inc_reduction, cum_coverage_2district, inc_reduction_2district) %>%
  arrange(scenario_cost)

View(results_df %>% filter(scenario_cost == "n10cm1_2districts_cost1"))

write.csv(results_df, "model_scenarios_2districts.csv", row.names = FALSE)
ggsave(plot = scenario_plot, "model_scenarios_plot_2districts.png", dpi = 300, width = 7, height = 5)


```

Appendix – district allocation methods (showing scenarios with additional facility-level population and capacity constraints).

Methods overview

The model requires three primary data inputs:
1. Facility catchment population data stratified by sex and age group (e.g., 15–19, 20–24, 25–49, 50+), and filtered to exclude facilities with low annual PrEP initiation volume (user-defined threshold).
2. Incidence estimates from the UNAIDS Naomi model stratified by sex, age group, and district, with additional sampling across incidence quantiles to enable stratified prioritization by risk group.
3. Facility coordinates and a district shapefile to support spatial mapping and district-level aggregation.
PrEP Allocation Algorithm

We implemented a stratified allocation function (allocate_prep_by_risk_with_stratified_prob) that distributes a fixed total number of PrEP units across age-sex-risk strata and facilities. The algorithm proceeds as follows:
1.	Catchment stratification: Facility-level catchment population is divided into sex- and age-specific groups, and then merged with district level incidence estimates by age and sex.
2.	Risk-group expansion: Each population subgroup is expanded across incidence strata to include quartiles of risk based on a gamma distribution with a mean equal to the district-level incidence. This gives four incidence groups per sub-group defined by quartile (0-25%, 25-50%, 50-75% and 75-100% of the incidence distribution). 
3.	Prioritization: Subgroups (facility/age/sex/risk strata) are ranked based on incidence. A user-defined coverage multiplier determines the maximum proportion of each subgroup eligible for allocation.
4. Unit allocation: Units are allocated sequentially until the total budget (units × cost per unit) is exhausted. Subgroups are capped based on size and maximum coverage thresholds.
5. Impact estimation: For each group receiving PrEP, we estimate infections averted using the formula:
Infections Averted = Allocated Units × (Incidence / 1000) × Efficacy
where efficacy was assumed to be 95%.

Scenario Modeling
We evaluated multiple budget and cost-per-unit scenarios using the run_cost_and_demand_scenarios() function. Each scenario returned:
- Facility-level allocation (result_df)
- Scenario summary metrics (summary_table)
- Stratified allocation summaries (facility_summary, by_province, by_prov_dist_age_sex)

We selected specific scenarios of interest using select_scenario_result(), based on total budget and cost assumptions.
For this exercise we allocated a fixed # of person-years of Len at 450,000.  Allocation was done by district without considering facility-level capacity or catchment populations.   

Visualization and Reporting
Spatial outputs were generated using map_prep_allocation_scenario(), which produces four figures:
1.	District allocation map
2.	District population coverage (% of population at risk covered by PrEP)
3.	Incidence reduction map (estimated % of new infections averted)
