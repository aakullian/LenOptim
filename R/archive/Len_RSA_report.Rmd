---
title: "Modeling the impact of Lenacapavir allocation strategies in South Africa"
author: "Adam Akullian"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 2
    number_sections: true
    css: styles.css
  pdf_document:
    toc: true
    toc_depth: '2'
---

```{r setup, include=FALSE, echo = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(dplyr)
library(tidyr)
library(ggplot2)
library(knitr)
library(purrr)
library(here)
library(kableExtra)
library(stringr)
library(purrr)
library(here)
library(gt)

# Optionally confirm the root:
here::here()  # prints the project root path

# Set working directory to a folder relative to the root
setwd(here("R/RSA_OUTPUT/Lenacapavir Scenario Comparison_v2_files"))  # change folder name as needed

# List all RData files matching a naming pattern
files <- list.files(pattern = "^Len_optim_RSA_output_.*\\.RData$")

# Optionally extract scenario names from filenames
scenario_labels <- gsub("\\.RData", "", basename(files))

# Load each RData into a separate environment
envs <- lapply(files, function(f) {
  e <- new.env()
  load(f, envir = e)
  e
})

scenario_tables <- map2(envs, scenario_labels, ~{
  .x$outputs$summary_table %>%
    mutate(scenario = .y)
})

scenario_maps <- map2(envs, scenario_labels, ~{
  .x$outputs$formatted_map
})

scenario_district_allocation <- map2(envs, scenario_labels, ~{
  .x$outputs$by_prov_dist_age_sex %>%
    mutate(scenario = .y)
})

combined_summary <- bind_rows(scenario_tables)

combined_summary_table <- combined_summary %>%
  select(-c(budget, cost_per_unit, total_cost))  %>%
  select(scenario, allocation_by_age_sex, everything())  %>%
  mutate(
    `target population` = str_extract(scenario, "(?<=__)[A-Z]*F\\d{2}-\\d{2}"),
    `number of gen pop risk groups` = as.numeric(str_extract(scenario, "(?<=n_)\\d+"))
  ) %>%
  rename(
    `scenario_id` = scenario,
    #`Budget (USD)` = budget,
    #`Cost per Unit` = cost_per_unit,
    #`Coverage Multiplier` = coverage_mult,
    `Total Units Allocated` = total_allocated_units,
    `Expected Infections (No PrEP)` = expected_infections_no_prep,
    `Infections Averted` = infections_averted,
    `Incidence Reduction (%)` = percent_reduction_in_incidence,
    `PrEP Coverage (%)` = prep_coverage,
    `Total DALYs Averted` = total_dalys_averted,
    #`Total Cost (USD)` = total_cost,
    `Cost per Infection Averted` = cost_per_infection_averted,
    `Cost per DALY Averted` = cost_per_daly_averted,
    `Number Needed to Treat (NNT)` = number_needed_to_treat,
    `Districts Allocated` = facilities_with_allocation,
    `Avg Incidence (Allocated)` = avg_incidence_allocated,
    `Avg Incidence (Population)` = avg_incidence_population,
    `Targeting Ratio` = incidence_targeting_ratio
    #`Allocation by Age/Sex/KP` = allocation_by_age_sex
  )  %>%
  mutate(
    # Strategy description
    scenario_description = case_when(
      str_detect(scenario_id, "NDOH_prioritization_GP") ~ "NDoH Prioritization Strategy, General Population",
      str_detect(scenario_id, "NDOH_prioritization_KP") ~ "NDoH Prioritization Strategy, Key Populations + General Population",
      str_detect(scenario_id, "DISTRICT") ~ "District Prioritization Strategy, General Population",
      TRUE ~ "Uncategorized Strategy"
    )
  ) %>%
  relocate(scenario_description, `target population`, `number of gen pop risk groups`, .after = scenario_id) %>%
  select(-scenario_id) %>%
  mutate(
    `Expected Infections (No PrEP)` = formatC(`Expected Infections (No PrEP)`, format = "f", digits = 0),
    `Infections Averted` = formatC(`Infections Averted`, format = "f", digits = 0),
    `Incidence Reduction (%)` = formatC(`Incidence Reduction (%)`, format = "f", digits = 1),
    `PrEP Coverage (%)` = formatC(`PrEP Coverage (%)`, format = "f", digits = 1),
    `Total DALYs Averted` = formatC(`Total DALYs Averted`, format = "f", digits = 0),
    `Cost per Infection Averted` = paste0("$", formatC(`Cost per Infection Averted`, format = "f", digits = 0, big.mark = ",")),
    `Cost per DALY Averted` = paste0("$", formatC(`Cost per DALY Averted`, format = "f", digits = 0, big.mark = ",")),
    `Number Needed to Treat (NNT)` = formatC(`Number Needed to Treat (NNT)`, format = "f", digits = 0),
    `Avg Incidence (Allocated)` = formatC(`Avg Incidence (Allocated)`, format = "f", digits = 1),
    `Avg Incidence (Population)` = formatC(`Avg Incidence (Population)`, format = "f", digits = 1),
    `Targeting Ratio` = formatC(`Targeting Ratio`, format = "f", digits = 1)
  ) %>%
  mutate(
    `target population` = case_when(
      scenario_description == "NDoH Prioritization Strategy, General Population" ~ "MF15-49",
      scenario_description == "NDoH Prioritization Strategy, Key Populations + General Population" ~ "MF15-49 + KPs",
      TRUE ~ `target population`  # keep existing values
    )
  ) %>%
  arrange(`number of gen pop risk groups`)

combined_summary_district <- bind_rows(scenario_district_allocation) 

# 1. Keep all non-numeric columns + numeric columns that are not all zeros
non_zero_cols <- names(combined_summary_district)[map_lgl(combined_summary_district, ~ !is.numeric(.x) || !all(.x %in% c(0, NA)))]

combined_summary_district = combined_summary_district  %>%

  select(all_of(non_zero_cols)) %>%

  # 2. Rename KP columns (and their percent versions)
  rename_with(~ str_replace_all(.x, c(
    "anc_15-49" = "Antenatal care",
    "gbmsm_15-49" = "Men who have sex with men",
    "sw_15-49" = "Female sex workers",
    "tgw_15-49" = "Transgender women",
    "anc_15-49_pct" = "Antenatal care pct",
    "gbmsm_15-49_pct" = "Men who have sex with men pct",
    "sw_15-49_pct" = "Female sex workers pct",
    "tgw_15-49_pct" = "Transgender women pct"
  ))) %>%

  # 3. Remove underscores from all column names
  rename_with(~ gsub("_", " ", .x)) %>%

  # 4. Move `scenario` column to the front
  relocate(scenario) %>%

  # 5. Reorder: each percent column comes right after its count column
  {
    cols <- names(.)
    pct_cols <- cols[grepl(" pct$", cols)]
    base_cols <- cols[!cols %in% pct_cols & cols != "scenario"]
    ordered_cols <- c("scenario")

    for (base in base_cols) {
      ordered_cols <- c(ordered_cols, base)
      pct_match <- paste0(base, " pct")
      if (pct_match %in% pct_cols) {
        ordered_cols <- c(ordered_cols, pct_match)
      }
    }

    select(., all_of(ordered_cols))
  } %>%

  # 6. Add (count) and (percent) labels to numeric columns
  rename_with(~ if_else(
    str_detect(.x, " pct$"),
    paste0(str_remove(.x, " pct$"), " (percent)"),
    paste0(.x, " (count)")
  ),
  .cols = where(is.numeric))



```

# Background

The South African National Department of Health (NDOH) is currently developing a Lenacapavir allocation plan, prioritized to high-risk populations in 25 identified districts. The impact of this plan and how it compares to other allocation scenarios, including a geographic prioritization framework, is explored here. 

# Methods

We developed a PrEP allocation model for South Africa to simulate the impact of different distribution scenarios for long-acting injectable PrEP (Lenacapavir).  

### Scenarios considered

We explored three scenarios:

1. **NDOH key population (KP) model:** Lenacapavir available in 25 districts, prioritized to female sex  
   workers, pregnant and breast-feeding women, gay and bi-sexual men who have sex with men, and transgender  
   women, as well as offered to general population adults 15–49 years of age.  

2. **NDOH general population model:** Lenacapavir available in 25 districts, with delivery to general  
   population adults 15–49 years of age only, without prioritization of KPs.  

3. **District prioritization model:** Lenacapavir available in all districts, with allocation based on  
   district-level incidence (stratified by age and sex), and delivery to general population adults 15–49  
   years of age only, without prioritization of KPs.

### Inputs and assumptions

In the NDOH scenarios, Lenacapavir is allocated to general population groups relative to the sizes of the populations at risk by age (15-19, 20-24, 25-34, 35-49) and sex, with women prioritized 2:1 over men. In scenarios where Lenacapavir is prioritized by district-level incidence, priority is given to the segment of the population with twice the incidence as the district average to reflect higher uptake among groups with elevated risk (Donnell et al., 2021). We use district-level incidence, prevalence, and population data from the UNAIDS Naomi model, a geo-statistical model based on population-level surveys, as the primary inputs into allocation models (https://naomi-spectrum.unaids.org/).  Incidence rates for key populations were estimated from data where available, and from calibrated HIV transmission models where not available. A total of 450,000 person-years of Lenacapavir (an overall coverage of 1.2% among HIV negative adults 15+ years of age) were allocated across all scenarios. Impact metrics (infections averted and % reduction in incidence); Cost effectiveness metrics (cost per DALY averted, cost per infection averted); and delivery efficiency metrics (number needed to treat, incidence in those allocated Lenacapavir) were estimated for each scenario. Analyses were conducted in R using custom functions for allocation, impact estimation, and visualization.

# Results

The proposed NDOH strategy with KP prioritization would avert 9,000 infections in adults 15 years and older over one year, a 6% reduction in incidence relative to the 146,000 infections expected to occur in the absence of Lenacapavir. In this scenario, Lenacapavir would be allocated to a population with an incidence of 21 per 1000 person-years, relative to the country level adult incidence of 3.9 per 1000 person-years. In a scenario where Lenacapavir is allocated to districts identified by NDOH but without prioritization of KPs, Lenacapavir would avert half as many infections (4,700), a 3.2% reduction in incidence. Under a strategy that prioritizes Lenacapavir allocation based on district-level incidence, Lenacapavir would avert between 10,000 and 15,000 infections (depending on the extent of higher-risk uptake), with up to 50% more infections averted compared to the NDOH KP-prioritized plan.  Under geographic prioritization scenarios, Lenacapavir would be allocated to between 15 and 44 districts, depending on the risk uptake assumption. 

# Conclusion

The planned allocation of Lenacapavir in 25 districts that prioritizes KPs would avert up to 50% fewer infections than allocation based on district-level incidence. The benefits of a geographic approach to Lenacapavir allocation should be weighed against the potential implementation challenges of delivering Lenacapavir to KPs in currently selected districts. 

# Tables and Figures

```{r scenario-map-1, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 10, fig.height = 10}

load("RSA_OUTPUT/extra_plots.RData")
print(ndoh_len_plan_plot)

```

# Scenario comparison table

```{r scenario-table, results = "asis"}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

#kable(combined_summary_table, caption = "Table 1: Scenario Summary Comparison")

# Wrap the long text column
#combined_summary_table$`Allocation by Age/Sex/KP` <- gsub(";\\s*", ";<br>", combined_summary_table$`Allocation by Age/Sex/KP`)

# Create the styled table
combined_summary_table_output <- combined_summary_table %>%
  kable(format = "html", escape = FALSE) %>%
  column_spec(2, width = "30em", extra_css = "word-wrap: break-word; white-space: normal;") %>%
  kable_styling(full_width = TRUE, bootstrap_options = c("striped", "hover"))

print(combined_summary_table_output)


```

# Scenario maps

```{r scenario-map-loop, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 20, fig.height = 10}

scenario_maps[[1]]
scenario_maps[[3]]
scenario_maps[[2]]
scenario_maps[[4]]
scenario_maps[[5]]

```

# Appendix

District allocation methods (showing scenarios with additional facility-level population and capacity constraints).**

**Methods and data Inputs:**

The model requires three primary data inputs:
1. Facility catchment population data stratified by sex and age group (e.g., 15–19, 20–24, 25–49, 50+), and filtered to exclude facilities with low annual PrEP initiation volume (user-defined threshold).
2. Incidence estimates stratified by sex, age group, and district, with additional sampling across incidence quantiles to enable stratified prioritization by risk group.
3. Facility coordinates and a district shapefile to support spatial mapping and district-level aggregation.
PrEP Allocation Algorithm

We implemented a stratified allocation function (allocate_prep_by_risk_with_stratified_prob) that distributes a fixed total number of PrEP units across age-sex-risk strata and facilities. The algorithm proceeds as follows:
1.	Catchment stratification: Facility-level catchment population is divided into sex- and age-specific groups, and then merged with district level incidence estimates by age and sex.
2.	Risk-group expansion: Each population subgroup is expanded across incidence strata to include quartiles of risk based on a gamma distribution with a mean equal to the district-level incidence. This gives four incidence groups per sub-group defined by quartile (0-25%, 25-50%, 50-75% and 75-100% of the incidence distribution). 
3.	Prioritization: Subgroups (facility/age/sex/risk strata) are ranked based on incidence. A user-defined coverage multiplier determines the maximum proportion of each subgroup eligible for allocation.
4. Unit allocation: Units are allocated sequentially until the total budget (units × cost per unit) is exhausted. Subgroups are capped based on size and maximum coverage thresholds.
5. Impact estimation: For each group receiving PrEP, we estimate infections averted using the formula:
Infections Averted = Allocated Units × (Incidence / 1000) × Efficacy
where efficacy was assumed to be 95%.

Scenario Modeling
We evaluated multiple budget and cost-per-unit scenarios using the run_cost_and_demand_scenarios() function. Each scenario returned:
- Facility-level allocation (result_df)
- Scenario summary metrics (summary_table)
- Stratified allocation summaries (facility_summary, by_province, by_prov_dist_age_sex)

We selected specific scenarios of interest using select_scenario_result(), based on total budget and cost assumptions.
For this exercise we allocated a fixed # of person-years of Len at 450,000.  Allocation was done by district without considering facility-level capacity or catchment populations.   

Visualization and Reporting
Spatial outputs were generated using map_prep_allocation_scenario(), which produces four figures:
1.	District allocation map
2.	District population coverage (% of population at risk covered by PrEP)
3.	Incidence reduction map (estimated % of new infections averted)
