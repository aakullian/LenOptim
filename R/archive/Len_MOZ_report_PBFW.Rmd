---
title: "Modeling the impact of Lenacapavir prioritization strategies in Mozambique"
author: "Adam Akullian, Daniel Shodell, Irenio Gaspar"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 2
    number_sections: true
    css: styles.css
  pdf_document:
    toc: true
    toc_depth: '2'
  word_document:
    toc: true
    toc_depth: '2'
---

```{r setup, include=FALSE, echo = FALSE, warning = FALSE, message = FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

library(dplyr)
library(tidyr)
library(ggplot2)
library(knitr)
library(purrr)
library(here)
library(kableExtra)
library(stringr)
library(purrr)
library(here)
library(gt)

# Optionally confirm the root:
here::here()  # prints the project root path

# Set working directory to a folder relative to the root
setwd(here("R/MOZ_OUTPUT/Distirct_allocation_PBFW_With_addl_PEPFAR_alloc"))  # change folder name as needed

# List all RData files matching a naming pattern
files <- list.files(pattern = "^Len_optim_MOZ_output_.*\\.RData$")

# Optionally extract scenario names from filenames
scenario_labels <- gsub("\\.RData", "", basename(files))

# Load each RData into a separate environment
envs <- lapply(files, function(f) {
  e <- new.env()
  load(f, envir = e)
  e
})

scenario_results <- map2(envs, scenario_labels, ~{
  .x$outputs$result_df %>%
    mutate(scenario = .y)
})

scenario_results <- map2(envs, scenario_labels, ~{
  get("outputs", envir = .x)$result_df %>%
    mutate(scenario = .y)
})

scenario_tables <- map2(envs, scenario_labels, ~{
  .x$outputs$summary_table %>%
    mutate(scenario = .y)
})

scenario_maps <- map2(envs, scenario_labels, ~{
  .x$outputs$formatted_map
})

scenario_district_allocation <- map2(envs, scenario_labels, ~{
  .x$outputs$by_prov_dist_age_sex %>%
    mutate(scenario = .y)
})

combined_results <- bind_rows(scenario_results) %>%
  select(scenario, district, group, allocated_units, cum_units, hiv_neg_preg_women, hiv_neg_non_preg_women, inc_nonpreg, inc_preg, infections_averted, maternal_infections_averted, vertical_infections_averted)  %>%
    filter(allocated_units > 0) %>%
  group_by(scenario) %>%
  summarise(
    total_units = sum(allocated_units),
    total_infections_averted = sum(infections_averted),
    total_maternal_infections_averted = sum(maternal_infections_averted),
    total_vertical_infections_averted = sum(vertical_infections_averted)
  )

combined_summary <- bind_rows(scenario_tables)  

# Calculate maternal and infant infections averted
rho <- 0.12 # vertical transmission rate
k <- 3  # scalar or vector from your script
# I_a <- infections_averted               # from your script
# maternal_averted <- I_a / (1 + rho * k)
# vertical_averted <- I_a * (rho * k) / (1 + rho * k)

combined_summary_table <- combined_summary %>%
  select(-c(budget, cost_per_unit, total_cost, expected_infections_no_prep, total_allocated_units, prep_coverage,avg_incidence_population,incidence_targeting_ratio))  %>%
  select(scenario, allocation_by_age_sex, everything()) %>%
  rename(
    `scenario_id` = scenario,
    #`Budget (USD)` = budget,
    #`Cost per Unit` = cost_per_unit,
    #`Coverage Multiplier` = coverage_mult,
    #`Total Units Allocated` = total_allocated_units,
    #`Expected Infections (No PrEP)` = expected_infections_no_prep,
    `Infections Averted` = infections_averted,
    `Incidence Reduction (%)` = percent_reduction_in_incidence,
    #`PrEP Coverage (%)` = prep_coverage,
    `Total DALYs Averted` = total_dalys_averted,
    #`Total Cost (USD)` = total_cost,
    `Cost per Infection Averted` = cost_per_infection_averted,
    `Cost per DALY Averted` = cost_per_daly_averted,
    `Number Needed to Treat (NNT)` = number_needed_to_treat,
    `Districts Allocated` = facilities_with_allocation,
    `Avg Incidence (Allocated)` = avg_incidence_allocated,
    #`Avg Incidence (Population)` = avg_incidence_population,
    #`Targeting Ratio` = incidence_targeting_ratio
    #`Allocation by Age/Sex/KP` = allocation_by_age_sex
  )  %>%
  mutate(
    # Strategy description
    `target population` = case_when(
      str_detect(scenario_id, "output_PBFW_prioritization") ~ "PBFW only",
      str_detect(scenario_id, "output_NON_PBFW_prioritization") ~ "Non PBFW",
      str_detect(scenario_id, "GENPOP") ~ "General population",
      TRUE ~ "Uncategorized Strategy"
    )
  ) %>%
  relocate(`target population`, .after = scenario_id) %>%
  #select(-scenario_id) %>%
  # mutate(
  #   `Maternal infections averted` = `Infections Averted` / (1 + rho * k),
  #   `Infant infections averted` = `Infections Averted` * (rho * k) / (1 + rho * k)) %>%
  mutate(
    `Maternal infections averted` = if_else(
      `target population` == "PBFW only",
      `Infections Averted` / (1 + rho * k),
      NA_real_
    ),
    `Infant infections averted` = if_else(
      `target population` == "PBFW only",
      `Infections Averted` * (rho * k) / (1 + rho * k),
      NA_real_
    )
  ) %>%
  mutate(
    #`Expected Infections (No PrEP)` = formatC(`Expected Infections (No PrEP)`, format = "f", digits = 0),
    `Infections Averted` = formatC(`Infections Averted`, format = "f", digits = 0),
    `Incidence Reduction (%)` = formatC(`Incidence Reduction (%)`, format = "f", digits = 1),
    #`PrEP Coverage (%)` = formatC(`PrEP Coverage (%)`, format = "f", digits = 1),
    `Total DALYs Averted` = formatC(`Total DALYs Averted`, format = "f", digits = 0),
    `Cost per Infection Averted` = paste0("$", formatC(`Cost per Infection Averted`, format = "f", digits = 0, big.mark = ",")),
    `Cost per DALY Averted` = paste0("$", formatC(`Cost per DALY Averted`, format = "f", digits = 0, big.mark = ",")),
    `Number Needed to Treat (NNT)` = formatC(`Number Needed to Treat (NNT)`, format = "f", digits = 0),
    `Avg Incidence (Allocated)` = formatC(`Avg Incidence (Allocated)`, format = "f", digits = 1)
    #`Avg Incidence (Population)` = formatC(`Avg Incidence (Population)`, format = "f", digits = 1),
    #`Targeting Ratio` = formatC(`Targeting Ratio`, format = "f", digits = 1)
  ) 

combined_summary_table <- combined_summary_table %>%
  mutate(
    `percent of target pop covered` = as.numeric(str_extract(scenario_id, "(?<=_)\\d+$"))
  ) %>%
  relocate(`percent of target pop covered`, .after = `target population`) %>%
  arrange(`target population`, `percent of target pop covered`) %>%
  select(-scenario_id) %>%
  # round maternal/infant to whole numbers
  mutate(
    `Maternal infections averted` = round(`Maternal infections averted`),
    `Infant infections averted`   = round(`Infant infections averted`)
  ) %>%
  # place them after Infections Averted
  relocate(`Maternal infections averted`, `Infant infections averted`,
           .after = `Infections Averted`) %>%
  # add commas (as strings) to these four fields without changing decimals
  mutate(
    `Infections Averted`               = prettyNum(`Infections Averted`, big.mark = ",", preserve.width = "none"),
    `Total DALYs Averted`              = prettyNum(`Total DALYs Averted`, big.mark = ",", preserve.width = "none")
  ) 

# %>%
#   mutate(scenario = row_number()) %>%
#   relocate(scenario, .before = `target population`)
```

# Background

We developed a district allocation model to simulate the impact of different prioritization scenarios for long-acting injectable PrEP (Lenacapavir) among women 15-34 across all districts in Mozambique. We compare scenarios that prioritize pregnant and breastfeeding women (PBFW) to those with only general population allocation. The model prioritizes Lenacapavir to districts (by age, sex, and risk-group) with the highest incidence based on data from the geostatistical UNAIDS Naomi model: https://naomi-spectrum.unaids.org/.  

# Methods

### Scenarios

A total of 46,500 person-years of PrEP (an overall coverage of 0.3% of all HIV negative adults 15-49 years of age) are allocated to women 15-34 considering two scenarios:

1. **Pregnant and breast-feeding women prioritized (PBFW):** Lenacapavir is prioritized exclusively to PBFW, 15-34 years of age 

1. **General population prioritized:** Lenacapavir is prioritized to women 15-34 years of age, with no prioiritization of PBFW 

We considered different uptake assumptions within those two scenarios, with Lenacapavir coverage ranging from 25% - 100% of the identified population at risk (i.e., each district, age-group, and risk strata). A higher uptake assumption concentrates Lenacapavir in fewer districts with the highest incidence, whereas a lower uptake assumption spreads Lenacapavir over more districts with lower incidence. 

### Inputs and assumptions

For PBFW scenarios, we estimated the number of HIV negative pregnant women in each district by age-group (15-24 and 25-34) using data from Zambezia and Gaza provinces on population counts of pregnant women and pregnant women living with HIV who attended at least one antenatal care clinic visit between Jan-Dec 2024 (SISMA - National HMIS). The estimated number of HIV negative pregnant women is adjusted for the probability of attending ANC (88.7% of pregnant women in Zambézia attended at least one ANC visit, 97.3% in Gaza, and 90.3% nationally). We assumed the pregnancy rate in women 15-24 years of age to be twice that of women 25-34 years of age. We also assumed that PBFW have twice the incidence as non-PBFW. We used an overall vertical transmission rate of 12% (estimated from country-level data). This rate includes vertical transmission from both PBFW with prevalent and incidence infection.  We assumed the vertical transmission rate to be 3 times higher in PBFW who acquire HIV during pregnancy or breastfeeding relative to those who present to ANC with HIV, based on an estimated 30% of vertical transmission from women with incident HIV (UNAIDS Spectrum HIV model). We model risk heterogeneity within a district/age group using a gamma distribution to account for skewness in how risk is distributed in a population, with small populations of high risk groups and large populations of low-to-moderate risk groups. We divide the population into 4 discrete risk groups with incidence for each group calculated from quartiles of the continuous risk distribution. For each scenario we estimated the number infections averted, (broken down by maternal versus infant infections averted for the PBFW scenarios); cost effectiveness metrics (cost per DALY averted, cost per infection averted); and delivery efficiency metrics (number needed to treat, incidence in those allocated Lenacapavir). Analyses were conducted in R using custom functions for allocation, impact estimation, and visualization. 

### Model assumptions and paramter values

```{r assumptions-table, results = "asis"}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

# Create the assumption table
zambezia_hivneg_n_preg = 487742 - 26862
gaza_hivneg_n_preg = 80075 - 11960
vert_trans_rate <- 0.17 * zambezia_hivneg_n_preg / (zambezia_hivneg_n_preg + gaza_hivneg_n_preg) + 0.11 * gaza_hivneg_n_preg / (zambezia_hivneg_n_preg + gaza_hivneg_n_preg)

assumption_table <- data.frame(
  Parameter = c(
    "Total PrEP availability",
    "Lenacapavir efficacy",
    "HIV negative pregnant women population (Gaza and Zambezia)",
    "Pregnancy rate among women 15-34 (# pregnant women per 100 women per year)",
    "Vertical transmission rate (Gaza and Zambezia)",
    "Proportion of vertical transmissions from incident maternal HIV",
    "Vertical transmission rate multiplier (incident vs prevalent maternal HIV)",
    "Incidence multiplier (PBFW vs non-PBFW)",
    "Pregnancy rate multiplier (15-24 vs 25-34)",
    "ANC attendance rate (National)",
    "Lenacapavir uptake among identified population at risk"
  ),
  Value = c(
    "46,500 person-years",
    "95%",
    zambezia_hivneg_n_preg+gaza_hivneg_n_preg,
    "30%",
    round(vert_trans_rate*100,1) %>% paste0("%"),
    "30%",
    "4x",
    "2x",
    "2x",
    "90.3%",
    "25 - 100%"
  ),
  source = c(
    "Program data",
    "Clinical trial data",
    "SISMA - National HMIS (Jan - Dec 2024)",
    "SISMA - National HMIS",
    "SISMA - National HMIS",
    "UNAIDS Spectrum model",
    "Derived from HIV prevalence in PBFW and proportion of vertical transmissions from incident maternal HIV",
    "Literature",
    "Assumption",
    "SISMA - National HMIS",
    "Assumption range"
  )
)

# Create the styled table
assumption_table %>%
  kable(format = "html", escape = FALSE) %>%
  column_spec(2, width = "30em", extra_css = "word-wrap: break-word; white-space: normal;") %>%
  kable_styling(full_width = TRUE, bootstrap_options = c("striped", "hover"))


```

# Results

A general population allocation strategy would avert between 1,100 - 1,500 infections over 1 year (2-2.3% incidence reduction) depending on uptake assumptions (25%-100% of the identified population at risk). Prioritizing Lenacapavir to PBFW would avert between 2,000 - 2,700 infections over 1 year (3-4% incidence reduction), approximately twice the number of infections averted compared to a general population strategy. Vertical transmissions accounted for 25% of the total infections averted in the PBFW scenarios. The cost per infection averted was lower when prioritizing PBFW ($1,700 - $2,300 per infection averted) compared to a general population strategy ($3,100-4,100 per infection averted). The number needed to treat (NNT) to avert one infection was also lower when prioritizing PBFW (17 - 23) compared to a general population strategy (31 - 42). Across scenarios, between 20 - 50 districts would receive Lenacapavir, with higher uptake scenarios resulting in fewer districts receiving Lenacapavir. In all scenarios, 70-75% of Lenacapavir was allocated to women 15-24 years of age and the average incidence in the population recieving Lenacapavir ranged from 25 per 1000 py to 44 per 1000 py.

### Scenario comparison table

```{r scenario-table, results = "asis"}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)

#kable(combined_summary_table, caption = "Table 1: Scenario Summary Comparison")

# Wrap the long text column
#combined_summary_table$`Allocation by Age/Sex/KP` <- gsub(";\\s*", ";<br>", combined_summary_table$`Allocation by Age/Sex/KP`)

# Create the styled table
combined_summary_table_output <- combined_summary_table %>%
  kable(format = "html", escape = FALSE) %>%
  column_spec(2, width = "30em", extra_css = "word-wrap: break-word; white-space: normal;") %>%
  kable_styling(full_width = TRUE, bootstrap_options = c("striped", "hover"))

print(combined_summary_table_output)


```

### Scenario maps

**General population allocation**

```{r scenario-map-loop1, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 20, fig.height = 10}

### Scenario map 1
scenario_maps[[1]]
cat("\n\n")  # blank line
cat("\n\n")  # blank line
cat("\n\n")  # blank line

```

**PBFW allocation**

```{r scenario-map-loop2, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 20, fig.height = 10}

### Scenario map 5
scenario_maps[[5]]
cat("\n\n")  # blank line
cat("\n\n")  # blank line
cat("\n\n")  # blank line

```

# Conclusion

Prioritizing Lenacapavir to PBFW would avert twice the number of infections as a general population strategy, with lower cost per infection averted and lower NNT. These findings suggest that prioritizing PBFW for Lenacapavir could be an efficient strategy to reduce HIV incidence among women in Mozambique, while also preventing vertical transmissions. Further analyses could explore the impact of varying total PrEP availability, different incidence and vertical transmission assumptions among PBFW, and longer time horizons.

# Appendix

### Additional scenario maps

```{r scenario-map-loop, echo = FALSE, warning = FALSE, message = FALSE, fig.width = 20, fig.height = 10}

### Scenario map 2
scenario_maps[[4]]
cat("\n\n")  # blank line
cat("\n\n")  # blank line
cat("\n\n")  # blank line
### Scenario map 3
scenario_maps[[3]]
cat("\n\n")  # blank line
cat("\n\n")  # blank line
cat("\n\n")  # blank line
### Scenario map 4
scenario_maps[[2]]
cat("\n\n")  # blank line
cat("\n\n")  # blank line
cat("\n\n")  # blank line
### Scenario map 5
scenario_maps[[8]]
cat("\n\n")  # blank line
cat("\n\n")  # blank line
cat("\n\n")  # blank line
### Scenario map 7
scenario_maps[[7]]
cat("\n\n")  # blank line
cat("\n\n")  # blank line
cat("\n\n")  # blank line
### Scenario map 8
scenario_maps[[6]]

```

### Additional methods

District allocation methods (showing scenarios with additional facility-level population and capacity constraints).

The model requires two primary data inputs:
1. Incidence estimates stratified by sex, age group, and district, with additional sampling across incidence quantiles to enable stratified prioritization by risk group.
2. Facility coordinates and a district shapefile to support spatial mapping and district-level aggregation.
PrEP Allocation Algorithm

We implemented a stratified allocation function (allocate_prep_by_risk_with_stratified_prob) that distributes a fixed total number of PrEP units across age-sex-risk strata and facilities. The algorithm proceeds as follows:
1.	District stratification: District-level counts of the HIV negative population is divided into sex- and age-specific groups, and then merged with district level incidence estimates by age and sex.
2.	Risk-group expansion: Each population subgroup is expanded across incidence strata to include quartiles of risk based on a gamma distribution with a mean equal to the district-level incidence. This gives four incidence groups per sub-group defined by quartile (0-25%, 25-50%, 50-75% and 75-100% of the incidence distribution). 
3.	Prioritization: Subgroups (district/age/sex/risk strata) are ranked based on incidence. A user-defined coverage multiplier determines the maximum proportion of each subgroup eligible for allocation.
4. Unit allocation: Units are allocated sequentially until the total budget (units × cost per unit) is exhausted. Subgroups are capped based on size and maximum coverage thresholds.
5. Impact estimation: For each group receiving PrEP, we estimate infections averted using the formula:
Infections Averted = Allocated Units × (Incidence / 1000) × Efficacy
where efficacy was assumed to be 95%.

Visualization and Reporting
Spatial outputs were generated using map_prep_allocation_scenario(), which produces four figures:
1.	District allocation map
2.	District population coverage (% of population at risk covered by PrEP)
3.	Incidence reduction map (estimated % of new infections averted)
